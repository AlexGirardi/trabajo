import React, { createContext, useContext, useState, useMemo, useEffect } from 'react';

export type Locale = 'es' | 'en';
interface Dict { [key: string]: string; }
interface Bundle { es: Dict; en: Dict; }

const translations: Bundle = {
  es: {
    'nav.dashboard': 'Dashboard',
    'nav.courses': 'Mis Cursos',
    'nav.generateExam': 'Generar Examen',
    'nav.exams': 'Mis Ex√°menes',
    'nav.settings': 'Configuraci√≥n',
  'nav.brand': 'EstudIA',
    'exam.generate.title': 'Generar Examen con IA',
    'exam.generate.subtitle': 'Crea ex√°menes personalizados usando inteligencia artificial',
    'exam.steps.selectCourse': 'Seleccionar Curso',
    'exam.steps.configure': 'Configurar Examen',
    'exam.steps.generate': 'Generar con IA',
    'exam.selectCourse.help': 'Selecciona el curso para generar el examen',
  'exam.selectCourse.courseLabel': 'Curso',
  'exam.material.available': 'Material disponible',
  'exam.material.none': 'Sin material espec√≠fico',
  'exam.material.manage': 'Gestionar Materiales',
  'exam.material.files': 'Este curso tiene {count} archivo(s) de material ({chars} caracteres total).',
  'exam.material.converted': '{count} archivo(s) convertido(s) de PDF a texto.',
  'exam.material.usedReal': 'Las preguntas se basar√°n en el contenido real subido.',
  'exam.material.noFiles.line1': 'No hay materiales espec√≠ficos subidos para este curso.',
  'exam.material.noFiles.line2': 'Se usar√° contenido gen√©rico. Para mejores resultados, sube material del curso.',
    'exam.button.back': 'Atr√°s',
    'exam.button.next': 'Siguiente',
    'exam.button.generate': 'Generar con IA',
    'exam.button.generating': 'Generando...',
    'exam.button.useExam': 'Usar Este Examen',
    'exam.button.newExam': 'Generar Nuevo Examen',
    'exam.generated.success': '¬°Examen generado exitosamente!',
    'exam.generated.count': 'Se han generado {count} preguntas usando IA.',
  'exam.generated.metadata': 'Metadatos del Examen (generados por IA)',
  'exam.questions.title': 'Preguntas Generadas:',
  'exam.summary.title': 'Resumen del examen',
  'exam.summary.course': 'Curso:',
  'exam.summary.questions': 'Preguntas:',
  'exam.summary.types': 'Tipos:',
  'exam.summary.difficulty': 'Dificultad:',
  'exam.summary.duration': 'Duraci√≥n:',
  'exam.summary.material': 'Material de estudio:',
  'exam.status.ollama.unavailable': 'Ollama no disponible',
  'exam.status.ollama.detail': 'Para generar ex√°menes con IA, necesitas tener Ollama instalado y ejecut√°ndose.',
  'exam.status.generating.title': 'Generando examen con IA...',
  'exam.status.generating.detail': 'Esto puede tomar unos momentos mientras la IA analiza el contenido',
  'exam.status.error.title': 'Error al generar examen',
  'exam.save.success': '¬°Examen guardado exitosamente! Puedes encontrarlo en la lista de ex√°menes del curso.',
  'exam.config.numQuestions': 'N√∫mero de preguntas: {count}',
  'exam.config.types': 'Tipos de preguntas:',
  'exam.config.difficulty': 'Dificultad',
  'exam.config.duration': 'Duraci√≥n (minutos)',
  'exam.type.multiple': 'Opci√≥n m√∫ltiple',
  'exam.type.verdadero_falso': 'Verdadero/Falso',
  'exam.type.abierta': 'Preguntas de completar',
  'exam.type.abierta.short': 'Completar',
  'exam.type.multiple.short': 'Multiple',
  'exam.type.verdadero_falso.short': 'V/F',
  'difficulty.facil': 'F√°cil',
  'difficulty.medio': 'Medio',
  'difficulty.dificil': 'Dif√≠cil',
  'label.true': 'Verdadero',
  'label.false': 'Falso',
  'exam.answer.correct': 'Respuesta correcta:',
  'exam.answer.suggested': 'Respuesta sugerida:',
  'exam.button.saveExam': 'Guardar Examen',
  'exam.generated.titleLabel': 'T√≠tulo:',
  'exam.generated.descriptionLabel': 'Descripci√≥n:',
  'info.localAI': 'IA Local con Ollama',
  'info.localAI.desc': 'Utilizamos Ollama para ejecutar modelos de IA localmente, garantizando privacidad y control total sobre tus datos.',
  'info.personalized': 'Contenido Personalizado',
  'info.personalized.desc': 'La IA analiza el contenido espec√≠fico de cada curso para generar preguntas relevantes y precisas.',
  'info.multiFormats': 'M√∫ltiples Formatos',
  'info.multiFormats.desc': 'Genera preguntas de opci√≥n m√∫ltiple, verdadero/falso y abiertas con diferentes niveles de dificultad.',
    'common.save': 'Guardar',
    'common.cancel': 'Cancelar',
  'common.language': 'Idioma',
  'common.theme': 'Tema',
  'common.spanish': 'Espa√±ol',
  'common.english': 'Ingl√©s',
  'common.light': 'Claro',
  'common.dark': 'Oscuro',
    'settings.title': 'Configuraci√≥n',
    'settings.appearance': 'Apariencia',
    'settings.appearance.subtitle': 'Idioma y tema visual',
    'settings.language': 'Idioma',
    'settings.theme': 'Tema',
    'theme.light': 'Claro',
    'theme.dark': 'Oscuro',
    'theme.toggle': 'Alternar',
  'settings.description': 'Personaliza tu experiencia en EstudIA',
  'settings.saved': 'Configuraci√≥n guardada correctamente',
  'settings.appearance.cardTitle': 'Apariencia',
  'settings.appearance.cardSubtitle': 'Idioma y tema visual',
  'settings.toggleTheme': 'Alternar {mode}',
  'confirm.delete.course': '¬øEst√°s seguro de que quieres eliminar el curso "{name}"?',
  'confirm.delete.material': '¬øEst√°s seguro de que quieres eliminar "{name}"?',
  'confirm.delete.exam': '¬øEst√°s seguro de que quieres eliminar este examen?',
  'exam.send.button': 'Enviar Examen',
  'exam.send.confirmTitle': 'Confirmar env√≠o del examen',
  'exam.send.confirmMessage': '¬øEst√°s seguro de que quieres enviar el examen?',
  'exam.loading': 'Cargando examen...',
  'exam.notFound': 'Examen no encontrado',
  'exam.retry': 'Repetir Examen',
  'exam.take': 'Realizar Examen',
  'exam.create': 'Crear Examen',
  'exam.create.first': 'Crear Mi Primer Examen',
  'exam.create.subtitle': 'Crea tu primer examen usando IA para empezar a estudiar',
  'exam.generate.cta': 'Generar Examen',
  'exam.generate.withAI': 'Generar Examen con IA',
  'exam.saved.log': 'Examen guardado:',
  'exam.error.save': 'Error al guardar examen:',
  'exam.error.generateUnknown': 'Error desconocido al generar el examen',
  'exam.error.connect': 'Error al conectar con el servicio de IA',
  'error.load.exam': 'Error al cargar el examen',
  'error.process.exam': 'Error al procesar el examen',
  'error.send.exam': 'Error al enviar el examen. Por favor, int√©ntalo de nuevo.',
  'error.invalid.exam': 'Error: Examen o preguntas no v√°lidos',
  'error.exam.notFound': 'Examen no encontrado',
  'error.invalid.examId': 'ID de examen no v√°lido',
  'exam.results.title': 'Resultados del Examen',
  'dashboard.generateExam': 'Generar Examen',
  'dashboard.noExam.cta': 'Crea tu primer examen para comenzar',
  'dashboard.noExam.aiCta': 'Genera un examen con IA para que aparezca aqu√≠.',
  'course.list.takeExam': 'Realizar Examen',
  'course.empty.title': 'No tienes cursos a√∫n',
  'course.empty.subtitle': 'Crea tu primer curso para comenzar a organizar tus materiales de estudio',
  'course.createNew': 'Crear Nuevo Curso',
  'course.createNew.subtitle': 'Comienza un nuevo curso de estudio',
  'course.materials.label': '{count} material(es)',
  'course.exams.label': '{count} examen(es)',
  'course.createdOn': 'Creado el {date}',
  'course.actions.exams': 'Ex√°menes',
  'course.actions.materials': 'Materiales',
  'common.edit': 'Editar',
  'common.delete': 'Eliminar',
  'dashboard.title': 'Dashboard',
  'dashboard.welcome': '¬°Bienvenido de vuelta! Aqu√≠ tienes un resumen de tu progreso.',
  'dashboard.info.startTitle': '¬°Comienza tu viaje de aprendizaje!',
  'dashboard.info.startBody': 'Para ver estad√≠sticas aqu√≠, primero crea un curso y completa algunos ex√°menes. Usa los botones de "Acciones R√°pidas" m√°s abajo para empezar.',
  'dashboard.stats.courses': 'Cursos Activos',
  'dashboard.stats.examsTaken': 'Ex√°menes Realizados',
  'dashboard.stats.averageScore': 'Puntuaci√≥n Media',
  'dashboard.stats.pendingExams': 'Ex√°menes Pendientes',
  'dashboard.answerDistribution': 'Distribuci√≥n de Respuestas',
  'dashboard.quickActions': 'Acciones R√°pidas',
  'dashboard.action.createCourse': 'Crear Curso',
  'dashboard.action.generateExam': 'Generar Examen',
  'dashboard.recentExams': 'Ex√°menes Recientes',
  'dashboard.recent.noneTitle': 'No hay ex√°menes recientes',
  'dashboard.recent.noneSubtitle': 'Crea tu primer examen para comenzar',
  'stats.correct': 'Correctas',
  'stats.incorrect': 'Incorrectas',
  'stats.unanswered': 'Sin responder',
  'exam.questions.count': '{count} preguntas',
  'exam.createdOn': 'Creado el {date}',
  'exam.default.title': 'Examen Generado',
  'exam.default.description': 'Examen generado autom√°ticamente',
  'exam.summary.material.files': '‚úÖ {count} archivo(s) cargado(s) ({chars} caracteres)',
  'exam.summary.material.converted': 'üìÑ {count} PDF(s) convertido(s) a texto',
  'exam.summary.material.usedReal': 'Las preguntas se basar√°n en el contenido real subido',
  'exam.summary.material.none': '‚ö†Ô∏è No hay materiales subidos',
  'exam.summary.material.generic': 'Se usar√° contenido gen√©rico del curso',
  'time.minutes': '{count} minutos',
  'courses.title': 'Mis Cursos',
  'courses.subtitle': 'Gestiona tus asignaturas y materiales de estudio',
  'exams.title': 'Mis Ex√°menes',
  'exams.subtitle': 'Gestiona y realiza tus ex√°menes',
  'exams.create': 'Crear Examen',
  'exams.empty.title': 'No hay ex√°menes disponibles',
  'exams.empty.subtitle': 'Crea tu primer examen usando IA para empezar a estudiar',
  'exams.create.first': 'Crear Mi Primer Examen',
  'exams.card.noDescription': 'Sin descripci√≥n',
  'exams.meta.questionsShort': '{count} preguntas',
  'exams.meta.minutesShort': '{count} min',
  'exams.action.take': 'Realizar Examen',
  'difficulty.normal': 'Normal',
  'takeExam.progress': 'Progreso',
  'takeExam.time.warning': '¬°Quedan menos de 5 minutos!',
  'takeExam.returnToExams': 'Volver a Ex√°menes',
  'takeExam.open.placeholder': 'Completa con una palabra...',
  'takeExam.open.helper': 'Escribe la palabra que completa la frase',
  'takeExam.confirm.answered': 'Preguntas respondidas: {answered} de {total}',
  'takeExam.confirm.timeRemaining': 'Tiempo restante: {time}',
  'results.grade.label': 'Calificaci√≥n:',
  'results.metric.correct': 'Respuestas Correctas',
  'results.metric.points': 'Puntos Obtenidos',
  'results.metric.timeUsed': 'Tiempo Utilizado',
  'results.metric.answered': 'Preguntas Respondidas',
  'results.review.title': 'Revisi√≥n Detallada',
  'results.action.backToExams': 'Volver a Ex√°menes',
  'results.action.retake': 'Repetir Examen',
  'results.answer.correct': 'Correcta',
  'results.answer.incorrect': 'Incorrecta',
  'results.answer.unanswered': 'Sin responder',
  'results.answer.explanation': 'Explicaci√≥n:',
  'results.message.excellent': '¬°Excelente trabajo!',
  'results.message.veryGood': '¬°Muy bien hecho!',
  'results.message.good': 'Buen trabajo',
  'results.message.improve': 'Necesitas mejorar',
  'results.message.studyMore': 'Debes estudiar m√°s',
  'common.back': 'Volver',
  },
  en: {
    'nav.dashboard': 'Dashboard',
    'nav.courses': 'My Courses',
    'nav.generateExam': 'Generate Exam',
    'nav.exams': 'My Exams',
    'nav.settings': 'Settings',
  'nav.brand': 'EstudIA',
    'exam.generate.title': 'Generate Exam with AI',
    'exam.generate.subtitle': 'Create personalized exams using artificial intelligence',
    'exam.steps.selectCourse': 'Select Course',
    'exam.steps.configure': 'Configure Exam',
    'exam.steps.generate': 'Generate with AI',
    'exam.selectCourse.help': 'Select a course to generate the exam',
  'exam.selectCourse.courseLabel': 'Course',
  'exam.material.available': 'Material available',
  'exam.material.none': 'No specific material',
  'exam.material.manage': 'Manage Materials',
  'exam.material.files': 'This course has {count} material file(s) ({chars} total characters).',
  'exam.material.converted': '{count} file(s) converted from PDF to text.',
  'exam.material.usedReal': 'Questions will be based on the uploaded content.',
  'exam.material.noFiles.line1': 'No specific materials uploaded for this course.',
  'exam.material.noFiles.line2': 'Generic content will be used. Upload material for better results.',
    'exam.button.back': 'Back',
    'exam.button.next': 'Next',
    'exam.button.generate': 'Generate with AI',
    'exam.button.generating': 'Generating...',
    'exam.button.useExam': 'Use This Exam',
    'exam.button.newExam': 'Generate New Exam',
    'exam.generated.success': 'Exam generated successfully!',
    'exam.generated.count': '{count} questions generated using AI.',
  'exam.generated.metadata': 'Exam Metadata (AI generated)',
  'exam.questions.title': 'Generated Questions:',
  'exam.summary.title': 'Exam Summary',
  'exam.summary.course': 'Course:',
  'exam.summary.questions': 'Questions:',
  'exam.summary.types': 'Types:',
  'exam.summary.difficulty': 'Difficulty:',
  'exam.summary.duration': 'Duration:',
  'exam.summary.material': 'Study material:',
  'exam.status.ollama.unavailable': 'Ollama unavailable',
  'exam.status.ollama.detail': 'To generate exams with AI you need Ollama installed and running.',
  'exam.status.generating.title': 'Generating exam with AI...',
  'exam.status.generating.detail': 'This may take a moment while the AI analyzes the content',
  'exam.status.error.title': 'Error generating exam',
  'exam.save.success': 'Exam saved successfully! You can find it in the course exams list.',
  'exam.config.numQuestions': 'Number of questions: {count}',
  'exam.config.types': 'Question types:',
  'exam.config.difficulty': 'Difficulty',
  'exam.config.duration': 'Duration (minutes)',
  'exam.type.multiple': 'Multiple choice',
  'exam.type.verdadero_falso': 'True/False',
  'exam.type.abierta': 'Fill in the blank',
  'exam.type.abierta.short': 'Blank',
  'exam.type.multiple.short': 'MCQ',
  'exam.type.verdadero_falso.short': 'T/F',
  'difficulty.facil': 'Easy',
  'difficulty.medio': 'Medium',
  'difficulty.dificil': 'Hard',
  'label.true': 'True',
  'label.false': 'False',
  'exam.answer.correct': 'Correct answer:',
  'exam.answer.suggested': 'Suggested answer:',
  'exam.button.saveExam': 'Save Exam',
  'exam.generated.titleLabel': 'Title:',
  'exam.generated.descriptionLabel': 'Description:',
  'info.localAI': 'Local AI with Ollama',
  'info.localAI.desc': 'We use Ollama to run AI models locally, ensuring privacy and full control of your data.',
  'info.personalized': 'Personalized Content',
  'info.personalized.desc': 'AI analyzes each course specific content to generate relevant and precise questions.',
  'info.multiFormats': 'Multiple Formats',
  'info.multiFormats.desc': 'Generate multiple choice, true/false and fill-in-the-blank questions with different difficulty levels.',
    'common.save': 'Save',
    'common.cancel': 'Cancel',
  'common.language': 'Language',
  'common.theme': 'Theme',
  'common.spanish': 'Spanish',
  'common.english': 'English',
  'common.light': 'Light',
  'common.dark': 'Dark',
    'settings.title': 'Settings',
    'settings.appearance': 'Appearance',
    'settings.appearance.subtitle': 'Language and visual theme',
    'settings.language': 'Language',
    'settings.theme': 'Theme',
    'theme.light': 'Light',
    'theme.dark': 'Dark',
    'theme.toggle': 'Toggle',
  'settings.description': 'Customize your experience in EstudIA',
  'settings.saved': 'Settings saved successfully',
  'settings.appearance.cardTitle': 'Appearance',
  'settings.appearance.cardSubtitle': 'Language and visual theme',
  'settings.toggleTheme': 'Toggle {mode}',
  'confirm.delete.course': 'Are you sure you want to delete the course "{name}"?',
  'confirm.delete.material': 'Are you sure you want to delete "{name}"?',
  'confirm.delete.exam': 'Are you sure you want to delete this exam?',
  'exam.send.button': 'Submit Exam',
  'exam.send.confirmTitle': 'Confirm exam submission',
  'exam.send.confirmMessage': 'Are you sure you want to submit the exam?',
  'exam.loading': 'Loading exam...',
  'exam.notFound': 'Exam not found',
  'exam.retry': 'Retake Exam',
  'exam.take': 'Take Exam',
  'exam.create': 'Create Exam',
  'exam.create.first': 'Create My First Exam',
  'exam.create.subtitle': 'Create your first AI-powered exam to start studying',
  'exam.generate.cta': 'Generate Exam',
  'exam.generate.withAI': 'Generate Exam with AI',
  'exam.saved.log': 'Exam saved:',
  'exam.error.save': 'Error saving exam:',
  'exam.error.generateUnknown': 'Unknown error generating exam',
  'exam.error.connect': 'Error connecting to AI service',
  'error.load.exam': 'Error loading exam',
  'error.process.exam': 'Error processing exam',
  'error.send.exam': 'Error submitting the exam. Please try again.',
  'error.invalid.exam': 'Error: Invalid exam or questions',
  'error.exam.notFound': 'Exam not found',
  'error.invalid.examId': 'Invalid exam ID',
  'exam.results.title': 'Exam Results',
  'dashboard.generateExam': 'Generate Exam',
  'dashboard.noExam.cta': 'Create your first exam to begin',
  'dashboard.noExam.aiCta': 'Generate an AI exam to show up here.',
  'course.list.takeExam': 'Take Exam',
  'course.empty.title': 'You have no courses yet',
  'course.empty.subtitle': 'Create your first course to organize your study materials',
  'course.createNew': 'Create New Course',
  'course.createNew.subtitle': 'Start a new study course',
  'course.materials.label': '{count} material(s)',
  'course.exams.label': '{count} exam(s)',
  'course.createdOn': 'Created on {date}',
  'course.actions.exams': 'Exams',
  'course.actions.materials': 'Materials',
  'common.edit': 'Edit',
  'common.delete': 'Delete',
  'dashboard.title': 'Dashboard',
  'dashboard.welcome': 'Welcome back! Here is a summary of your progress.',
  'dashboard.info.startTitle': 'Start your learning journey!',
  'dashboard.info.startBody': 'To see statistics here, first create a course and complete some exams. Use the "Quick Actions" buttons below to begin.',
  'dashboard.stats.courses': 'Active Courses',
  'dashboard.stats.examsTaken': 'Exams Taken',
  'dashboard.stats.averageScore': 'Average Score',
  'dashboard.stats.pendingExams': 'Pending Exams',
  'dashboard.answerDistribution': 'Answer Distribution',
  'dashboard.quickActions': 'Quick Actions',
  'dashboard.action.createCourse': 'Create Course',
  'dashboard.action.generateExam': 'Generate Exam',
  'dashboard.recentExams': 'Recent Exams',
  'dashboard.recent.noneTitle': 'No recent exams',
  'dashboard.recent.noneSubtitle': 'Create your first exam to begin',
  'stats.correct': 'Correct',
  'stats.incorrect': 'Incorrect',
  'stats.unanswered': 'Unanswered',
  'exam.questions.count': '{count} questions',
  'exam.createdOn': 'Created on {date}',
  'exam.default.title': 'Generated Exam',
  'exam.default.description': 'Exam automatically generated',
  'exam.summary.material.files': '‚úÖ {count} file(s) uploaded ({chars} characters)',
  'exam.summary.material.converted': 'üìÑ {count} PDF(s) converted to text',
  'exam.summary.material.usedReal': 'Questions will be based on the uploaded real content',
  'exam.summary.material.none': '‚ö†Ô∏è No materials uploaded',
  'exam.summary.material.generic': 'Generic course content will be used',
  'time.minutes': '{count} minutes',
  'courses.title': 'My Courses',
  'courses.subtitle': 'Manage your subjects and study materials',
  'exams.title': 'My Exams',
  'exams.subtitle': 'Manage and take your exams',
  'exams.create': 'Create Exam',
  'exams.empty.title': 'No exams available',
  'exams.empty.subtitle': 'Create your first AI-powered exam to start studying',
  'exams.create.first': 'Create My First Exam',
  'exams.card.noDescription': 'No description',
  'exams.meta.questionsShort': '{count} questions',
  'exams.meta.minutesShort': '{count} min',
  'exams.action.take': 'Take Exam',
  'difficulty.normal': 'Normal',
  'takeExam.progress': 'Progress',
  'takeExam.time.warning': 'Less than 5 minutes left!',
  'takeExam.returnToExams': 'Back to Exams',
  'takeExam.open.placeholder': 'Fill in with a word...',
  'takeExam.open.helper': 'Type the word that completes the sentence',
  'takeExam.confirm.answered': 'Answered questions: {answered} of {total}',
  'takeExam.confirm.timeRemaining': 'Time remaining: {time}',
  'results.grade.label': 'Grade:',
  'results.metric.correct': 'Correct Answers',
  'results.metric.points': 'Points Earned',
  'results.metric.timeUsed': 'Time Used',
  'results.metric.answered': 'Answered Questions',
  'results.review.title': 'Detailed Review',
  'results.action.backToExams': 'Back to Exams',
  'results.action.retake': 'Retake Exam',
  'results.answer.correct': 'Correct',
  'results.answer.incorrect': 'Incorrect',
  'results.answer.unanswered': 'Unanswered',
  'results.answer.explanation': 'Explanation:',
  'results.message.excellent': 'Excellent work!',
  'results.message.veryGood': 'Great job!',
  'results.message.good': 'Good job',
  'results.message.improve': 'Needs improvement',
  'results.message.studyMore': 'You need to study more',
  'common.back': 'Back',
  }
};

interface I18nContextValue {
  locale: Locale;
  t: (key: string, vars?: Record<string,string|number>) => string;
  setLocale: (l: Locale) => void;
}

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

export const useI18n = () => {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
};

export const I18nProvider: React.FC<{children: React.ReactNode}> = ({ children }) => {
  const [locale, setLocale] = useState<Locale>('es');

  useEffect(()=>{
    const stored = localStorage.getItem('ui.locale');
    if (stored === 'es' || stored === 'en') setLocale(stored);
  },[]);

  const t = (key: string, vars?: Record<string,string|number>) => {
    const dict = translations[locale];
    let value = dict[key] || key;
    if (vars) {
      Object.entries(vars).forEach(([k,v])=>{
        value = value.replace(new RegExp(`{${k}}`,'g'), String(v));
      });
    }
    return value;
  };

  const setAndPersist = (l: Locale) => { setLocale(l); localStorage.setItem('ui.locale', l); };

  const value = useMemo(()=>({ locale, t, setLocale: setAndPersist }), [locale]);

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
};
